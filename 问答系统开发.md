# 问答系统开发说明（HDMS）

## 目标与范围
面向“高强度片区数字化管控平台（HDMS）”，逐步构建**基于资料的问答系统**，并与**知识图谱**联动展示。当前阶段以**最小可用问答**为主，后续迭代 OCR、向量化检索与图谱构造。

---

## 当前进展

### 1) 前端问答与渲染
- **主问答面板**：`frontend/components/qa-panel.tsx`
  - 已接入真实接口 `/qa/chat`，接口不可用时回退为本地简答。
  - **支持 Markdown 渲染**（表格、列表、代码块、引用等）。
  - 增加 `normalizeMarkdownLists`，自动修复“重复 1.”导致的有序列表渲染问题。
- **Markdown 渲染依赖**：
  - `react-markdown`
  - `remark-gfm`

### 2) 知识图谱展示（前端）
- `frontend/components/knowledge-graph.tsx`
  - 使用 `react-force-graph-2d`。
  - 支持**列表视图**与**图谱视图**切换。
  - 当前展示为**静态示例 + 选中要素关联**（尚未接入真实图数据库）。

### 3) 后端问答接口
- FastAPI 新增接口：`POST /qa/chat`
  - 路径：`services/rhino-api/rhino_api/features/qa/api.py`
  - 调用 OpenAI 兼容接口（当前使用 `HDMS_BASE_URL` / `HDMS_API_KEY` / `HDMS_MODEL`）。
  - 自动向上查找并读取根目录 `.env`，避免环境变量未注入导致 400。

### 4) 同源代理（前端）
- `frontend/app/qa/chat/route.ts`
  - 前端统一调用 `/qa/chat`，由 Next.js 转发到后端 `http://localhost:8000/qa/chat`，避免跨域与端口不一致。

### 5) 容器化基础设施（为后续准备）
`docker-compose.yml` 已包含：
- **Milvus**（向量数据库）
- **Neo4j**（图数据库）
- **MinIO**（对象存储）
- **Postgres / MongoDB / etcd**

---

## 已达成效果
1. 前端问答可使用真实接口返回答案。
2. 支持 Markdown 渲染（表格/代码/列表正确展示）。
3. 知识图谱组件可展示核心要素关系（当前为静态示例）。
4. 接口不可用时保留可用 fallback，避免 UI 中断。

---

## 下一阶段规划（重点）

### A. 资料接入与 OCR
1. **资料上传**（PDF/图片/扫描件）
2. OCR 识别（计划使用 `qwen3-vl-plus`）
3. 输出结构化文本（章节/标题/条文）

### B. 向量化与检索
1. 文本分段（chunking）
2. 生成向量（embedding）
3. 写入 Milvus（向量索引）
4. 问答时检索最相关片段（RAG）
5. **答案引用来源**（文件名/章节/条款）

### C. 知识图谱构造
1. 从资料中抽取：  
   - **管控要素（实体）**  
   - **约束关系（边）**  
   - **指标/阈值（属性）**
2. 写入 Neo4j
3. 问答结果返回关联的图谱节点（用于前端高亮）

### D. 多模态与空间联动
1. 与现有 3D 场景关联
2. 图谱节点 ↔ 方案要素联动选中

---

## 相关模块清单（当前）

**前端**
- `frontend/components/qa-panel.tsx`（问答主面板，Markdown 渲染）
- `frontend/components/knowledge-graph.tsx`（图谱展示）
- `frontend/app/qa/chat/route.ts`（同源代理）

**后端**
- `services/rhino-api/rhino_api/features/qa/api.py`（问答接口）

---

## 后续协作建议
- 优先通过“新增模块”扩展功能，减少合并冲突。
- 旧模块如需替换逻辑，先对齐接口与测试流程。
