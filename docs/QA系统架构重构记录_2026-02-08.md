# QA 系统架构重构记录

> 日期：2026-02-08

## 背景

在重构之前，问答系统的请求链路存在一个不合理的设计：

```
用户提问 → 前端 → qa_assistant(8002) → data_process(8004) → 数据库 → LLM → 原路返回
```

`qa_assistant` 只是一个"传话筒"——流式问答时，它把请求原封不动转发给 `data_process`，再把响应原封不动传回前端。非流式问答更糟糕：它直接调 LLM，完全没有检索能力。

这意味着：
- 每次问答多一次网络跳转，增加延迟
- `data_process` 同时承担"数据入库"和"问答服务"两个职责，职责不清
- `qa_assistant` 作为一个独立服务却没有实质逻辑

## 重构目标

让两个服务各司其职：

```
data_process(8004)：数据进来、处理好、存进去，到此为止
qa_assistant(8002)：直连数据库，自己检索、自己生成、自己返回
```

## 重构后的架构

```
                    ┌─────────────────────────────┐
                    │         前端 (3000)          │
                    │   Next.js + React + Three.js │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │      Nginx 网关 (8000)       │
                    │   /qa/* → 8002               │
                    │   /rag/* → 8002              │
                    │   /ingestion/* → 8004        │
                    │   /graph/* → 8004            │
                    └──┬───────────────────────┬──┘
                       │                       │
          ┌────────────▼──────────┐  ┌────────▼─────────────┐
          │  qa_assistant (8002)  │  │  data_process (8004) │
          │                       │  │                       │
          │  用户提问              │  │  PDF / OCR 输出       │
          │    ↓                  │  │    ↓                  │
          │  多源检索              │  │  语义分块              │
          │  (Milvus+Neo4j+Mongo)│  │    ↓                  │
          │    ↓                  │  │  向量嵌入 → Milvus    │
          │  拼接上下文            │  │    ↓                  │
          │    ↓                  │  │  实体提取 → Neo4j     │
          │  调用 LLM             │  │    ↓                  │
          │    ↓                  │  │  文档存储 → MongoDB   │
          │  流式返回答案          │  │                       │
          └───────────┬──────────┘  └───────────────────────┘
                      │
          ┌───────────▼──────────────────────────┐
          │          数据服务层 (Docker)           │
          │  Milvus (向量) │ Neo4j (图谱)         │
          │  MongoDB (文档) │ MinIO │ PostgreSQL   │
          └──────────────────────────────────────┘
```

## 项目目录结构

```
HDMS/
├── frontend/                          # 前端（未改动）
│   ├── app/qa/chat/                   #   问答代理路由
│   ├── features/qa/                   #   问答功能模块
│   ├── components/qa-panel.tsx        #   问答面板
│   └── lib/sse-client.ts             #   SSE 流式客户端
│
├── backend/
│   ├── qa_assistant/                  # 问答助手服务 ← 本次重构重点
│   │   ├── app.py                     #   FastAPI 入口（含 DB 生命周期管理）
│   │   ├── core/
│   │   │   ├── config.py              #   配置（DB / Embedding / LLM / CORS）
│   │   │   └── database/              #   数据库客户端
│   │   │       ├── manager.py         #     连接管理器（启动时初始化三个库）
│   │   │       ├── milvus_client.py   #     Milvus 向量搜索
│   │   │       ├── mongodb_client.py  #     MongoDB 文档/全文搜索
│   │   │       └── neo4j_client.py    #     Neo4j 图谱查询
│   │   ├── rag/                       #   RAG 检索与生成
│   │   │   ├── retriever.py           #     多源检索器（向量+图谱+关键词融合）
│   │   │   ├── service.py             #     RAG 服务（prompt 构建 + LLM 调用 + 流式输出）
│   │   │   ├── embedder.py            #     查询向量嵌入
│   │   │   └── graph_query.py         #     知识图谱只读查询
│   │   ├── schemas/
│   │   │   └── rag_schemas.py         #   请求/响应模型
│   │   └── routes/
│   │       └── qa.py                  #   API 端点
│   │
│   └── review_system/                 # 审查系统（未改动）
│
├── data_process/                      # 数据处理服务 ← 移除了问答逻辑
│   ├── main.py                        #   FastAPI 入口（仅 ingestion + graph 路由）
│   ├── core/database/                 #   数据库客户端（独立副本）
│   ├── vector_process/
│   │   └── ingestion/                 #   文档分块、向量嵌入、入库
│   ├── KG_process/                    #   知识图谱构建
│   └── ocr_process/                   #   OCR 处理
│
├── nginx/hdms.conf                    # 网关路由配置
├── docker-compose.yml                 # 数据库服务编排
├── start_all.py                       # 一键启动脚本
└── .env                               # 环境变量
```

## 当前实现的效果

### 问答能力

- **多源检索**：每次提问同时查询三个数据库
  - Milvus 向量相似度搜索（语义匹配）
  - Neo4j 知识图谱查询（地块指标、关系）
  - MongoDB 全文关键词搜索（精确匹配）
  - 三路结果按权重融合排序

- **流式回答**：支持 SSE 实时流式输出
  - 先返回来源引用信息
  - 再返回推理过程（DeepSeek-R1 的 thinking）
  - 最后逐 token 返回答案
  - 前端实时渲染，体验流畅

- **来源引用**：答案中标注 [1]、[2] 等引用编号，可点击查看原文

- **对话记忆**：保留最近 8 轮对话历史，支持追问

### API 端点

| 端点 | 说明 |
|------|------|
| `POST /qa/chat` | 非流式问答，返回完整答案 + 来源 |
| `POST /qa/chat/stream` | 流式问答，SSE 实时推送 |
| `GET /rag/sources/{chunk_id}` | 查看引用来源的原文详情 |
| `GET /health/db` | 查看三个数据库的连接状态和统计 |

### 数据处理能力（data_process，未改动）

- OCR 文档识别
- 语义分块（按标题、表格、token 数切分）
- 向量嵌入生成（text-embedding-3-large，3072 维）
- 图片描述生成（qwen3-vl-plus 视觉模型）
- 知识图谱自动构建（LLM 实体提取 + 正则兜底）

## 接下来可以优化的方向

### 检索质量

- 引入 Reranker 模型对检索结果二次排序，提升相关性
- 支持 Hybrid Search（Milvus 原生稀疏+稠密混合检索）
- 优化分块策略，尝试更小粒度或滑动窗口分块
- 图谱查询扩展：支持多跳关系推理

### 性能与缓存

- 热门问题缓存（Redis），避免重复检索和生成
- Embedding 缓存，相同查询不重复调用嵌入 API
- 数据库连接池优化

### 功能扩展

- 增量更新：文档修改后只更新变化的 chunk，不全量重建
- 多模态检索：图片也生成向量，支持"以图搜图"
- 审批清单自动生成：结合知识图谱和规范文档，自动生成审查要点
- 权限管理：不同用户看到不同范围的文档

### 前端体验

- 来源引用卡片优化：展示更多上下文、高亮匹配段落
- 知识图谱可视化联动：点击答案中的地块编号，图谱自动定位
- 对话导出：支持将问答记录导出为 PDF 或 Markdown
