# HDMS 问答系统定位说明

> 更新日期：2026-02-09

---

## 1. 系统定位

HDMS 问答系统的完整定位为：

> **面向高强度片区的城市设计知识问答系统**

它隶属于「城市高强度片区协同设计管理平台研发及技术验证」课题体系，是其中子课题五「城市高强度片区数字化管控工具」的核心功能模块。

该系统不是通用闲聊机器人，不是开放域百科助手，而是服务于城市设计与管控决策过程的专业知识问答系统。其技术本质是 **RAG（检索增强生成）管线**——通过多源检索（向量、图谱、关键词）获取证据，再由大语言模型生成结构化回答。

---

## 2. 业务背景与目标

高强度片区的设计管理涉及多主体（政府、开发方、设计方、运维方）、多要素（指标、规范、方案、实施）、多流程（方案编制、审查、实施、运维），存在知识碎片化和信息不对称问题。

HDMS 问答系统的目标是通过知识库、知识图谱、RAG 等技术，提供「有用 + 好用」的决策支持：

- 快速检索关键知识依据，减少人工翻阅资料的时间
- 输出结构化、可执行的分析建议，而非泛泛而谈
- 明确证据来源与引用关系，做到「言之有据」
- 支持方案编制、审查、实施、运维各阶段的问题求解
- 当证据不足时，明确告知信息缺口与建议补充方向

---

## 3. 服务对象

系统面向但不限于以下角色：

| 角色 | 典型使用场景 |
|------|------------|
| 政府管理方 | 查询管控指标、审查依据、政策规范 |
| 投资开发建设方 | 了解地块约束条件、开发强度限制 |
| 城市设计方 | 方案评估依据、设计导则查询、指标对比 |
| 运维管理方 | 运维阶段的管控要求、变更依据 |
| 课题研究人员 | 知识库验证、数据检索、研究支撑 |

---

## 4. 课题体系与知识架构

### 4.1 课题体系

HDMS 所属的上级课题为「城市高强度片区协同设计管理平台研发及技术验证」，下设五个子课题：

| 课题 | 研究方向 | 知识接入状态 |
|------|---------|------------|
| 课题一 | 城市高强度片区复杂型城市设计理论 | 规划接入 |
| 课题二 | 高强度片区环境性能评估与指标体系研究 | 规划接入 |
| 课题三 | 高强度片区使用效能评估与指标体系研究 | 规划接入 |
| 课题四 | 高强度片区人本性能评估与指标体系研究 | 规划接入 |
| **课题五** | **城市高强度片区数字化管控工具开发** | **已接入（核心知识源）** |

### 4.2 知识演进路线

```
当前阶段（已完成）
  └─ 课题五项目知识 → Milvus 向量库 + Neo4j 知识图谱 + MongoDB 文档库

近期规划
  ├─ 课题一~四知识逐步入库
  └─ 外部相关论文、专著、规范、案例接入

远期目标
  └─ 形成覆盖高强度片区城市设计全生命周期的知识体系
```

### 4.3 知识边界规则

- 若问题涉及已接入知识范围，系统基于检索证据回答，并标注引用编号
- 若问题涉及规划接入但尚未入库的课题知识，系统必须明确告知「该课题知识尚未接入」
- 若问题明显超出城市设计领域，系统礼貌说明不在支持范围
- 禁止臆造「已有依据」或伪造引用来源

---

## 5. 意图理解与检索策略

### 5.1 LLM 意图分类器（主路径）

系统在检索前通过一次轻量级 LLM 调用对用户输入进行意图分类和查询改写。

**六类意图：**

| 意图 | 说明 | 是否检索 | 示例 |
|------|------|---------|------|
| `greeting` | 问候、寒暄、感谢、告别 | 否 | "你好"、"谢谢" |
| `domain` | 城市设计管控相关问题 | 是 | "容积率控制的依据是什么" |
| `follow_up` | 追问（含指代词，依赖历史） | 是（top_k 提升） | "那第二步呢" |
| `out_of_scope` | 明显非城市设计领域 | 否 | "今天天气怎么样" |
| `meta` | 询问系统能力/身份/使用方法 | 否 | "你能做什么" |
| `clarification` | 过于模糊无法判断 | 是 | "说说看" |

**查询改写：**
- `follow_up` 意图时，分类器会将指代词（那、这个、它）替换为历史中的具体实体
- `domain` 意图时，若原句已清晰则不改写

**LLM 调用参数：** `temperature=0.0, max_tokens=150, timeout=8s, response_format=json_object`

### 5.2 规则分类器（降级路径）

当 LLM 分类器调用失败（超时、解析错误等）时，自动降级为基于关键词的规则分类器：

- 正则匹配问候模式 → `greeting`
- 元问题关键词匹配 → `meta`
- 非领域关键词匹配 → `out_of_scope`
- 有历史 + 短句 + 指代词 → `follow_up`
- 领域关键词匹配 → `domain`
- 默认 → `domain`（保守策略，宁可多检索不遗漏）

### 5.3 检索权重策略

检索阶段根据查询内容动态调整三路检索的融合权重：

| 查询类型 | 向量权重 | 图谱权重 | 关键词权重 |
|---------|---------|---------|----------|
| 含地块编号（如 DU01-01） | 0.25 | 0.55 | 0.20 |
| 含指标关键词（容积率、限高等） | 0.35 | 0.45 | 0.20 |
| 一般查询 | 0.55 | 0.20 | 0.25 |

### 5.4 配置变量

| 变量 | 默认值 | 说明 |
|------|-------|------|
| `INTENT_CLASSIFIER_ENABLED` | `true` | 是否启用 LLM 意图分类器 |
| `INTENT_CLASSIFIER_MODEL` | （空，使用 HDMS_MODEL） | 分类器使用的模型 |
| `INTENT_CLASSIFIER_TIMEOUT` | `8` | 分类器超时时间（秒） |

---

## 6. 回答质量规范

### 6.1 证据优先级（从高到低）

1. 课题五项目知识（当前核心）
2. 已接入的课题一至四知识
3. 已接入外部论文、专著、规范、案例
4. 通用常识（仅作补充，不得替代专业依据）

### 6.2 推荐输出结构

视问题复杂度灵活调整：

- **结论**（1-2 句核心回答）
- **关键依据**（引用检索资料，标注 [1][2] 编号）
- **实施建议**（涉及策略、流程、落地时提供）
- **信息缺口**（证据不足时，说明需补充的资料方向）

简单问题（定义查询、单一指标查询）可直接回答，无需完整四段结构。

### 6.3 引用规范

- 所有来自参考资料的事实句必须在句末标注 `[1][2]` 格式引用
- 不得编造不存在的引用编号
- 若参考资料为空或证据不足，必须明确说明「当前知识库暂无直接依据」，并给出「建议补充资料」方向

### 6.4 禁止行为

- 不得自称「通用智能体」或暗示具备超出知识库的能力
- 不得伪造引用来源或编号
- 不得对超出范围的问题给出专业性回答

---

## 7. 多轮对话原则

- 支持基于近 8 轮历史的追问理解
- 对指代不清的问题，LLM 意图分类器会尝试将指代词替换为历史中的具体实体
- 缓存 key 包含历史摘要（最近 2 条用户消息各前 50 字），确保同一问题在不同上下文产生不同缓存条目
- 回答需保持与上文一致，不应出现「同词不同义」的无解释切换

---

## 8. 技术实现要点

### 8.1 核心模块路径

| 模块 | 路径 | 职责 |
|------|------|------|
| 意图分类器 | `backend/qa_assistant/rag/intent_classifier.py` | LLM 意图分类 + 查询改写 + 规则降级 |
| RAG 服务 | `backend/qa_assistant/rag/service.py` | 系统提示词 + 检索编排 + LLM 生成 |
| 多源检索器 | `backend/qa_assistant/rag/retriever.py` | 向量/图谱/关键词三路检索 + 融合排序 |
| 查询缓存 | `backend/qa_assistant/rag/cache.py` | LRU + TTL 缓存，支持历史感知 key |
| 配置 | `backend/qa_assistant/core/config.py` | 所有环境变量配置 |
| 数据模型 | `backend/qa_assistant/schemas/rag_schemas.py` | 请求/响应 Pydantic 模型 |

### 8.2 数据流

```
用户提问
  |
  v
意图分类器（LLM / 规则降级）
  |-- intent: greeting/meta/out_of_scope → 跳过检索，直接生成
  |-- intent: domain/follow_up/clarification → 进入检索
  |-- rewritten_query（追问时替换指代词）
  |
  v
缓存检查（key = 问题 + 历史摘要）
  |-- 命中 → 直接返回
  |-- 未命中 → 继续
  |
  v
多源检索（Milvus 向量 + Neo4j 图谱 + MongoDB 关键词）
  |-- 动态权重融合
  |-- 可选 Reranker 二次排序
  |
  v
构建上下文 + 引用来源
  |
  v
系统提示词 + 历史 + 上下文 + 问题 → LLM 生成
  |
  v
流式返回（SSE: intent → sources → retrieval_stats → thinking → answer → done）
```

### 8.3 SSE 事件序列

| 事件 | 数据 | 说明 |
|------|------|------|
| `intent` | `{intent, rewritten_query, confidence}` | 意图分类结果 |
| `sources` | `{sources: [...]}` | 引用来源列表 |
| `retrieval_stats` | `{vector_count, graph_count, ...}` | 检索统计 |
| `thinking` | `{content: "..."}` | 推理过程（DeepSeek-R1） |
| `answer` | `{content: "..."}` | 逐 token 回答 |
| `done` | `{model, context_used, cached}` | 完成标记 |

---

## 9. 对用户与编程助手的约束

### 9.1 对用户

- 优先提出与高强度片区城市设计相关的问题
- 对关键结论建议要求「引用依据 + 可执行建议」
- 追问时尽量提供足够上下文，避免过于模糊的指代

### 9.2 对编程助手（代码改造时）

- 不得将系统描述为「通用智能体」
- 新增能力需先声明知识边界与证据来源
- 涉及提示词修改时，需同步维护本说明文档
- 涉及意图/检索策略修改时，需补充对应测试
- Python print 语句避免使用 emoji（Windows GBK 编码限制），使用 `[OK]`、`[FAIL]` 等纯文本

---

## 10. 后续演进路线

### 已完成

- [x] LLM 意图分类器 + 查询改写（替代纯规则分类）
- [x] 缓存 key 包含历史上下文摘要
- [x] 系统提示词增加课题体系表格、服务对象、禁止行为
- [x] 前端文案统一为「城市设计知识问答」定位
- [x] 意图分类器规则降级路径
- [x] SSE 新增 `intent` 事件

### 下一步

- [ ] 课题一~四知识入库与接入状态动态标记
- [ ] 外部论文/书籍知识接入
- [ ] 意图分类器基于反馈数据微调
- [ ] 回答结构从弱约束 Markdown 升级为可选 Schema 化输出
- [ ] 建立覆盖核心场景的问答评测集（准确性/引用率/可执行性）
- [ ] 领域外问题专门响应模板，减少答非所问
- [ ] 知识图谱可视化与问答联动（点击答案中的地块编号，图谱自动定位）

---

如本定位与实际课题推进不一致，以课题组最新口径为准，并及时更新本文档。
