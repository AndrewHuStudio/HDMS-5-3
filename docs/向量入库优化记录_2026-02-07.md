# 向量化入库优化记录（2026-02-07）

## 文档位置
- 本次整理文档：`docs/向量入库优化记录_2026-02-07.md`
- 相关实现总结（已有）：`docs/RAG系统实现总结.md`

## 本次优化目标
针对向量化入库链路（chunk -> image enhance -> embedding -> Milvus/Mongo 持久化 -> 状态报告）中的稳定性、准确性、性能问题进行修复，重点包括：
1. 向量不包含图片语义
2. report 接口不必要的全量哈希开销
3. 图片路径含空格解析失败
4. CJK 字符切分在极端参数下可能死循环
5. 同哈希多文档状态匹配不稳定

## 优化结果总览

### 1) 向量与检索文本语义对齐（已修复）
- 修复前：embedding 基于原始 chunk 文本，图片描述只追加到 Milvus `text`，导致向量语义不完整。
- 修复后：先构造 `enhanced_texts`（已注入图片描述），再统一生成 embeddings。
- 关键位置：
  - `data_process/vector_process/ingestion/pipeline.py:185`
  - `data_process/vector_process/ingestion/pipeline.py:190`
  - `data_process/vector_process/ingestion/pipeline.py:209`
  - `data_process/vector_process/ingestion/pipeline.py:292`

### 2) report 接口性能优化（已修复）
- 修复前：每个文档都读取 markdown 并计算哈希。
- 修复后：优先按标准化路径命中 Mongo 记录，仅路径未命中时才回退算哈希。
- 关键位置：
  - `data_process/vector_process/ingestion/api.py:206`
  - `data_process/vector_process/ingestion/api.py:250`
  - `data_process/vector_process/ingestion/api.py:254`

### 3) 图片引用含空格的解析（已修复）
- 修复前：`split()[0]` 会把 `images/Quarter 1.png` 截断为 `images/Quarter`。
- 修复后：遵循 CommonMark 规则，保留路径空格，仅移除可选 title/anchor/query。
- 关键位置：
  - `data_process/vector_process/ingestion/chunker.py:349`
  - `data_process/vector_process/ingestion/chunker.py:354`
  - `data_process/vector_process/ingestion/chunker.py:363`

### 4) CJK 分块边界安全（已修复）
- 修复前：当 `overlap >= chunk_size` 时，字符分块起点可能不前进。
- 修复后：新增步长保护，确保每轮至少前进 1；并补充 chunker 参数校验。
- 关键位置：
  - `data_process/vector_process/ingestion/chunker.py:28`
  - `data_process/vector_process/ingestion/chunker.py:281`
  - `data_process/vector_process/ingestion/chunker.py:286`

### 5) 同哈希多文档匹配稳定性（已修复）
- 修复前：`docs_by_hash` 一对一映射会覆盖同哈希文档。
- 修复后：改为一对多列表，并通过 `_select_best_doc` 做确定性选择（同名优先 + 状态优先级 + 时间）。
- 关键位置：
  - `data_process/vector_process/ingestion/api.py:34`
  - `data_process/vector_process/ingestion/api.py:216`
  - `data_process/vector_process/ingestion/api.py:260`

## 附带改进
- 入库时统一保存 `markdown_path` 为绝对路径，降低路径匹配抖动。
  - `data_process/vector_process/ingestion/pipeline.py:130`
- Mongo chunk 记录新增 `enhanced_text` 字段，便于审计最终入向量文本。
  - `data_process/vector_process/ingestion/pipeline.py:239`

## 验证情况
- 语法编译验证：
  - `python -m compileall data_process/vector_process/ingestion/chunker.py data_process/vector_process/ingestion/pipeline.py data_process/vector_process/ingestion/api.py`
- 关键行为冒烟验证：
  - 图片路径空格解析正常
  - `overlap >= chunk_size` 时分块可终止
  - 同哈希候选文档选择逻辑符合预期
  - 图片描述注入去重生效

## 影响评估
- 检索准确性：提升（向量包含图片描述语义）
- 报告接口性能：提升（减少不必要的文件读取与哈希计算）
- 处理稳定性：提升（避免极端参数下分块卡死、减少哈希冲突误匹配）
- 可观测性：提升（Mongo 可看到 `enhanced_text`）
