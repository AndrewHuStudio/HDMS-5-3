services:
  postgres:
    image: postgres:15-alpine
    container_name: hdms-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: hdms_password_2024
      POSTGRES_DB: postgres
    ports:
      - "5434:5432"
    volumes:
      - hdms-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hdms-network

  mongodb:
    image: mongo:7.0
    container_name: hdms-mongodb
    restart: unless-stopped
    ports:
      - "27019:27017"  
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: hdms2024
      MONGO_INITDB_DATABASE: hdms
    volumes:
      - F:/HDMS_data/mongodb:/data/db
      - F:/HDMS_data/mongodb_config:/data/configdb
    networks:
      - hdms-network

  etcd:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: hdms-etcd
    restart: unless-stopped
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "8589934592"
      ETCD_SNAPSHOT_COUNT: "50000"
    volumes:
      - F:/HDMS_data/etcd:/etcd
    command: >
      etcd -advertise-client-urls=http://127.0.0.1:2381
           -listen-client-urls http://0.0.0.0:2381
           --data-dir /etcd
    ports:
      - "2381:2381"  
    networks:
      - hdms-network

  minio:
    image: minio/minio:RELEASE.2024-08-17T01-24-54Z
    container_name: hdms-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_BROWSER: "off"
    volumes:
      - F:/HDMS_data/minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    ports:
      - "9004:9000"
      - "9005:9001"  
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - hdms-network

  milvus:
    image: milvusdb/milvus:v2.6.2
    container_name: hdms-milvus
    restart: unless-stopped
    depends_on:
      - etcd
      - minio
    environment:
      MILVUS_DEPLOY_MODE: standalone
      ETCD_ENDPOINTS: etcd:2381
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      DATA_COORD_SEGMENT_MAX_SIZE: "512"
      LOG_LEVEL: info
    volumes:
      - F:/HDMS_data/milvus:/var/lib/milvus
    ports:
      - "19532:19530"
      - "9093:9091"    
    command: ["milvus", "run", "standalone"]
    networks:
      - hdms-network

  neo4j:
    image: neo4j:5.13-community
    container_name: hdms-neo4j
    restart: unless-stopped
    ports:
      - "7476:7474"
      - "7689:7687"
    environment:
      NEO4J_AUTH: neo4j/hdms2024
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
      NEO4J_server_memory_heap_max__size: 2G
    volumes:
      - hdms-neo4j-data:/data
      - hdms-neo4j-logs:/logs
    networks:
      - hdms-network

networks:
  hdms-network:
    driver: bridge

volumes:
  hdms-postgres-data:
  hdms-neo4j-data:
  hdms-neo4j-logs:
